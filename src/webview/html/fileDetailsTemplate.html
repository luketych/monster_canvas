<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Details</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: var(--vscode-editor-background);
      color: var(--vscode-editor-foreground);
      font-family: var(--vscode-font-family);
      box-sizing: border-box;
    }

    .header {
      padding: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .file-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .file-path {
      font-size: 14px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 10px;
    }

    .file-details {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .detail-value {
      font-size: 14px;
    }

    .view-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      padding: 5px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .view-button {
      padding: 5px 10px;
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .view-button.active {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    /* List View */
    .children-container.list-view {
      display: flex;
      flex-direction: column;
      gap: 5px;
      overflow-y: auto;
      flex: 1;
    }

    .children-container.list-view .child-item {
      display: grid;
      grid-template-columns: 30px 1fr 80px 1fr;
      grid-template-areas: "icon name cover stickers";
      align-items: center;
      padding: 8px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      cursor: pointer;
      background-color: var(--vscode-editor-background);
    }

    /* Icons View */
    .children-container.icons-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      overflow-y: auto;
      flex: 1;
      padding: 15px;
    }

    .children-container.icons-view .child-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 10px;
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
    }

    .children-container.icons-view .child-item:hover {
      border-color: var(--vscode-panel-border);
      background-color: var(--vscode-list-hoverBackground);
    }

    .children-container.icons-view .child-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .children-container.icons-view .child-name {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100px;
    }

    .children-container.icons-view .child-cover,
    .children-container.icons-view .child-stickers {
      display: none;
    }

    /* Columns View */
    .children-container.columns-view {
      display: flex;
      overflow-x: auto;
      flex: 1;
    }

    .column {
      min-width: 250px;
      max-width: 300px;
      border-right: 1px solid var(--vscode-panel-border);
      overflow-y: auto;
      height: 100%;
    }

    .column-header {
      padding: 8px;
      font-weight: bold;
      border-bottom: 1px solid var(--vscode-panel-border);
      background-color: var(--vscode-editor-background);
      position: sticky;
      top: 0;
    }

    .children-container.columns-view .child-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      cursor: pointer;
    }

    .children-container.columns-view .child-icon {
      margin-right: 8px;
    }

    .children-container.columns-view .child-cover,
    .children-container.columns-view .child-stickers {
      display: none;
    }

    /* Gallery View */
    .children-container.gallery-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      overflow-y: auto;
      flex: 1;
      padding: 15px;
    }

    .children-container.gallery-view .child-item {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
    }

    .children-container.gallery-view .child-cover {
      width: 100%;
      height: 120px;
      background-color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .children-container.gallery-view .child-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .children-container.gallery-view .child-info {
      padding: 8px;
      display: flex;
      align-items: center;
    }

    .children-container.gallery-view .child-icon {
      margin-right: 8px;
    }

    .children-container.gallery-view .child-stickers {
      display: none;
    }

    /* Accordion behavior */
    .folder-children {
      margin-left: 20px;
      border-left: 1px solid var(--vscode-panel-border);
      padding-left: 10px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }

    .folder-children.expanded {
      max-height: 1000px;
      /* Arbitrary large value */
      transition: max-height 0.5s ease-in;
    }

    .child-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .child-icon {
      grid-area: icon;
      font-size: 18px;
      text-align: center;
    }

    .child-name {
      grid-area: name;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 10px;
    }

    .child-cover {
      grid-area: cover;
      width: 60px;
      height: 40px;
      background-color: #333;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
      margin: 0 10px;
      cursor: pointer;
      position: relative;
    }

    .child-cover:hover::after {
      content: "Click to set cover";
      position: absolute;
      bottom: -20px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
      background-color: var(--vscode-editor-background);
      padding: 2px;
      border-radius: 2px;
      z-index: 10;
    }

    .child-stickers {
      grid-area: stickers;
      display: flex;
      gap: 5px;
      overflow-x: auto;
      padding: 0 5px;
      min-height: 30px;
      align-items: center;
      cursor: pointer;
    }

    .child-stickers:empty::after {
      content: "No stickers. Click to add some.";
      color: var(--vscode-descriptionForeground);
      font-size: 11px;
      font-style: italic;
    }

    .sticker {
      width: 24px;
      height: 24px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sticker img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 2px;
    }

    .error-message {
      color: var(--vscode-errorForeground);
      padding: 10px;
      margin-top: 10px;
      border: 1px solid var(--vscode-errorForeground);
      border-radius: 4px;
    }

    /* Comments container */
    .comments-container {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }

    .comment {
      margin-bottom: 15px;
      padding: 8px;
      background-color: var(--vscode-editor-inactiveSelectionBackground);
      border-radius: 4px;
    }

    .comment pre {
      margin: 0;
      white-space: pre-wrap;
      font-family: var(--vscode-editor-font-family);
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="file-name" id="fileName">Loading...</div>
    <div class="file-path" id="filePath"></div>
    <div class="file-details" id="fileDetails"></div>
  </div>

  <div class="children-container" id="childrenContainer"></div>

  <script>
    (function () {
      const vscode = acquireVsCodeApi();

      // State
      let currentFileUri = null;
      let currentFileDetails = null;
      let children = [];

      // Elements
      const fileNameElement = document.getElementById('fileName');
      const filePathElement = document.getElementById('filePath');
      const fileDetailsElement = document.getElementById('fileDetails');
      const childrenContainerElement = document.getElementById('childrenContainer');

      // Function to format file size
      function formatFileSize(size) {
        if (size < 1024) {
          return size + ' B';
        } else if (size < 1024 * 1024) {
          return (size / 1024).toFixed(2) + ' KB';
        } else if (size < 1024 * 1024 * 1024) {
          return (size / (1024 * 1024)).toFixed(2) + ' MB';
        } else {
          return (size / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }
      }

      // Function to format date
      function formatDate(date) {
        return new Date(date).toLocaleString();
      }

      // Function to get icon for file type
      function getFileTypeIcon(type) {
        switch (type) {
          case 'directory':
            return 'ðŸ“';
          case 'javascript':
            return 'ðŸ“„ JS';
          case 'typescript':
            return 'ðŸ“„ TS';
          case 'json':
            return 'ðŸ“„ JSON';
          case 'html':
            return 'ðŸ“„ HTML';
          case 'css':
            return 'ðŸ“„ CSS';
          case 'markdown':
            return 'ðŸ“„ MD';
          case 'python':
            return 'ðŸ“„ PY';
          case 'image':
            return 'ðŸ–¼ï¸';
          default:
            return 'ðŸ“„';
        }
      }

      // Function to display file details
      function displayFileDetails(details) {
        // Update state
        currentFileDetails = details;

        // Update file name and path
        fileNameElement.textContent = details.name;
        filePathElement.textContent = details.path;

        // Update file details
        fileDetailsElement.innerHTML = '';

        // Type
        const typeItem = document.createElement('div');
        typeItem.className = 'detail-item';

        const typeLabel = document.createElement('div');
        typeLabel.className = 'detail-label';
        typeLabel.textContent = 'Type';
        typeItem.appendChild(typeLabel);

        const typeValue = document.createElement('div');
        typeValue.className = 'detail-value';
        typeValue.textContent = details.type;
        typeItem.appendChild(typeValue);

        fileDetailsElement.appendChild(typeItem);

        // Size (if not a directory)
        if (!details.isDirectory) {
          const sizeItem = document.createElement('div');
          sizeItem.className = 'detail-item';

          const sizeLabel = document.createElement('div');
          sizeLabel.className = 'detail-label';
          sizeLabel.textContent = 'Size';
          sizeItem.appendChild(sizeLabel);

          const sizeValue = document.createElement('div');
          sizeValue.className = 'detail-value';
          sizeValue.textContent = formatFileSize(details.size);
          sizeItem.appendChild(sizeValue);

          fileDetailsElement.appendChild(sizeItem);
        }

        // Created
        const createdItem = document.createElement('div');
        createdItem.className = 'detail-item';

        const createdLabel = document.createElement('div');
        createdLabel.className = 'detail-label';
        createdLabel.textContent = 'Created';
        createdItem.appendChild(createdLabel);

        const createdValue = document.createElement('div');
        createdValue.className = 'detail-value';
        createdValue.textContent = formatDate(details.created);
        createdItem.appendChild(createdValue);

        fileDetailsElement.appendChild(createdItem);

        // Modified
        const modifiedItem = document.createElement('div');
        modifiedItem.className = 'detail-item';

        const modifiedLabel = document.createElement('div');
        modifiedLabel.className = 'detail-label';
        modifiedLabel.textContent = 'Modified';
        modifiedItem.appendChild(modifiedLabel);

        const modifiedValue = document.createElement('div');
        modifiedValue.className = 'detail-value';
        modifiedValue.textContent = formatDate(details.modified);
        modifiedItem.appendChild(modifiedValue);

        fileDetailsElement.appendChild(modifiedItem);
      }

      // Current view mode
      let currentViewMode = 'list';

      // Function to create view controls
      function createViewControls() {
        const viewControlsElement = document.createElement('div');
        viewControlsElement.className = 'view-controls';

        const viewModes = [
          { id: 'list', label: 'List' },
          { id: 'icons', label: 'Icons' },
          { id: 'columns', label: 'Columns' },
          { id: 'gallery', label: 'Gallery' }
        ];

        viewModes.forEach(mode => {
          const button = document.createElement('button');
          button.className = 'view-button' + (mode.id === currentViewMode ? ' active' : '');
          button.textContent = mode.label;
          button.dataset.mode = mode.id;

          button.addEventListener('click', () => {
            // Update active button
            document.querySelectorAll('.view-button').forEach(btn => {
              btn.classList.remove('active');
            });
            button.classList.add('active');

            // Update view mode
            currentViewMode = mode.id;

            // Update container class
            childrenContainerElement.className = 'children-container ' + mode.id + '-view';

            // Save view mode preference
            if (currentFileDetails && currentFileDetails.isDirectory) {
              const updatedDetails = { ...currentFileDetails, viewMode: mode.id };
              vscode.postMessage({
                command: 'saveFileDetails',
                fileUri: currentFileUri,
                details: updatedDetails
              });
            }

            // Redisplay children with new view mode
            displayChildren(children, mode.id);
          });

          viewControlsElement.appendChild(button);
        });

        return viewControlsElement;
      }

      // Function to display children
      function displayChildren(childrenData, viewMode = currentViewMode) {
        // Update state
        children = childrenData;
        currentViewMode = viewMode;

        // Clear container
        childrenContainerElement.innerHTML = '';

        // Set view mode class
        childrenContainerElement.className = 'children-container ' + viewMode + '-view';

        // Add view controls if we have children and this is a directory
        if (currentFileDetails && currentFileDetails.isDirectory) {
          const viewControls = createViewControls();
          childrenContainerElement.appendChild(viewControls);
        }

        // Handle different view modes
        switch (viewMode) {
          case 'list':
            displayListView(children);
            break;
          case 'icons':
            displayIconsView(children);
            break;
          case 'columns':
            displayColumnsView(children);
            break;
          case 'gallery':
            displayGalleryView(children);
            break;
          default:
            displayListView(children);
        }
      }

      // Function to display list view
      function displayListView(children) {
        children.forEach(child => {
          const childElement = document.createElement('div');
          childElement.className = 'child-item';
          childElement.dataset.uri = child.uri;

          // Icon
          const iconElement = document.createElement('div');
          iconElement.className = 'child-icon';
          iconElement.textContent = getFileTypeIcon(child.type);
          childElement.appendChild(iconElement);

          // Name
          const nameElement = document.createElement('div');
          nameElement.className = 'child-name';
          nameElement.textContent = child.name;
          childElement.appendChild(nameElement);

          // Cover
          const coverElement = document.createElement('div');
          coverElement.className = 'child-cover';
          if (child.coverImage) {
            const imgElement = document.createElement('img');
            imgElement.src = child.coverImage;
            coverElement.appendChild(imgElement);
          } else {
            coverElement.textContent = 'No cover';
          }

          // Add click handler for cover image
          coverElement.addEventListener('click', (e) => {
            e.stopPropagation();
            // Send message to select cover image
            vscode.postMessage({
              command: 'selectCoverImage',
              fileUri: child.uri
            });
          });

          childElement.appendChild(coverElement);

          // Stickers
          const stickersElement = document.createElement('div');
          stickersElement.className = 'child-stickers';
          if (child.stickers && child.stickers.length > 0) {
            child.stickers.forEach(sticker => {
              const stickerElement = document.createElement('div');
              stickerElement.className = 'sticker';

              // If sticker is a path to an image
              if (typeof sticker === 'string' && (sticker.endsWith('.png') || sticker.endsWith('.jpg') || sticker.endsWith('.jpeg') || sticker.endsWith('.gif'))) {
                const imgElement = document.createElement('img');
                imgElement.src = sticker;
                stickerElement.appendChild(imgElement);
              } else {
                stickerElement.textContent = sticker;
              }

              stickersElement.appendChild(stickerElement);
            });
          }

          // Add click handler for stickers
          stickersElement.addEventListener('click', (e) => {
            e.stopPropagation();
            // Send message to select stickers
            vscode.postMessage({
              command: 'selectStickers',
              fileUri: child.uri
            });
          });

          childElement.appendChild(stickersElement);

          // Click handler for folders (accordion behavior)
          if (child.isDirectory) {
            childElement.addEventListener('click', (e) => {
              e.stopPropagation();

              // Check if folder children already exist
              const existingChildren = document.querySelector('.folder-children[data-parent="' + child.uri + '"]');

              if (existingChildren) {
                // Toggle expanded state
                existingChildren.classList.toggle('expanded');
              } else {
                // Create folder children container
                const folderChildren = document.createElement('div');
                folderChildren.className = 'folder-children expanded';
                folderChildren.dataset.parent = child.uri;

                // Add loading indicator
                const loadingElement = document.createElement('div');
                loadingElement.textContent = 'Loading...';
                folderChildren.appendChild(loadingElement);

                // Insert after the current child
                childElement.parentNode.insertBefore(folderChildren, childElement.nextSibling);

                // Request children
                vscode.postMessage({
                  command: 'getChildren',
                  fileUri: child.uri
                });
              }
            });
          } else {
            // Click handler for files
            childElement.addEventListener('click', () => {
              vscode.postMessage({
                command: 'openFile',
                fileUri: child.uri
              });
            });
          }

          childrenContainerElement.appendChild(childElement);
        });
      }

      // Function to display icons view
      function displayIconsView(children) {
        children.forEach(child => {
          const childElement = document.createElement('div');
          childElement.className = 'child-item';
          childElement.dataset.uri = child.uri;

          // Icon
          const iconElement = document.createElement('div');
          iconElement.className = 'child-icon';
          iconElement.textContent = getFileTypeIcon(child.type);
          childElement.appendChild(iconElement);

          // Name
          const nameElement = document.createElement('div');
          nameElement.className = 'child-name';
          nameElement.textContent = child.name;
          childElement.appendChild(nameElement);

          // Click handler
          if (child.isDirectory) {
            childElement.addEventListener('click', () => {
              vscode.postMessage({
                command: 'getFileDetails',
                fileUri: child.uri
              });
            });
          } else {
            childElement.addEventListener('click', () => {
              vscode.postMessage({
                command: 'openFile',
                fileUri: child.uri
              });
            });
          }

          childrenContainerElement.appendChild(childElement);
        });
      }

      // Function to display columns view
      function displayColumnsView(children) {
        // Create column
        const column = document.createElement('div');
        column.className = 'column';

        // Add column header
        const header = document.createElement('div');
        header.className = 'column-header';
        header.textContent = currentFileDetails ? currentFileDetails.name : 'Files';
        column.appendChild(header);

        // Add children
        children.forEach(child => {
          const childElement = document.createElement('div');
          childElement.className = 'child-item';
          childElement.dataset.uri = child.uri;

          // Icon
          const iconElement = document.createElement('div');
          iconElement.className = 'child-icon';
          iconElement.textContent = getFileTypeIcon(child.type);
          childElement.appendChild(iconElement);

          // Name
          const nameElement = document.createElement('div');
          nameElement.className = 'child-name';
          nameElement.textContent = child.name;
          childElement.appendChild(nameElement);

          // Click handler
          if (child.isDirectory) {
            childElement.addEventListener('click', () => {
              // Remove any columns to the right
              const columns = document.querySelectorAll('.column');
              let foundCurrent = false;

              columns.forEach(col => {
                if (foundCurrent) {
                  col.remove();
                }
                if (col === column) {
                  foundCurrent = true;
                }
              });

              // Request children
              vscode.postMessage({
                command: 'getChildren',
                fileUri: child.uri
              });
            });
          } else {
            childElement.addEventListener('click', () => {
              vscode.postMessage({
                command: 'openFile',
                fileUri: child.uri
              });
            });
          }

          column.appendChild(childElement);
        });

        childrenContainerElement.appendChild(column);
      }

      // Function to display gallery view
      function displayGalleryView(children) {
        children.forEach(child => {
          const childElement = document.createElement('div');
          childElement.className = 'child-item';
          childElement.dataset.uri = child.uri;

          // Cover
          const coverElement = document.createElement('div');
          coverElement.className = 'child-cover';
          if (child.coverImage) {
            const imgElement = document.createElement('img');
            imgElement.src = child.coverImage;
            coverElement.appendChild(imgElement);
          } else {
            // If no cover, show icon
            coverElement.textContent = getFileTypeIcon(child.type);
            coverElement.style.fontSize = '32px';
          }
          childElement.appendChild(coverElement);

          // Info section (icon + name)
          const infoElement = document.createElement('div');
          infoElement.className = 'child-info';

          // Icon
          const iconElement = document.createElement('div');
          iconElement.className = 'child-icon';
          iconElement.textContent = getFileTypeIcon(child.type);
          infoElement.appendChild(iconElement);

          // Name
          const nameElement = document.createElement('div');
          nameElement.className = 'child-name';
          nameElement.textContent = child.name;
          infoElement.appendChild(nameElement);

          childElement.appendChild(infoElement);

          // Click handler
          if (child.isDirectory) {
            childElement.addEventListener('click', () => {
              vscode.postMessage({
                command: 'getFileDetails',
                fileUri: child.uri
              });
            });
          } else {
            childElement.addEventListener('click', () => {
              vscode.postMessage({
                command: 'openFile',
                fileUri: child.uri
              });
            });
          }

          childrenContainerElement.appendChild(childElement);
        });
      }

      // Function to display file comments
      function displayFileComments(comments, filePath) {
        // Clear container
        childrenContainerElement.innerHTML = '';

        // Create comments container
        const commentsContainer = document.createElement('div');
        commentsContainer.className = 'comments-container';

        // Add heading
        const heading = document.createElement('h3');
        heading.textContent = 'Comments from ' + path.basename(filePath);
        heading.style.marginBottom = '15px';
        commentsContainer.appendChild(heading);

        if (comments.length === 0) {
          // No comments found
          const noComments = document.createElement('p');
          noComments.textContent = 'No comments found in this file.';
          noComments.style.fontStyle = 'italic';
          noComments.style.color = 'var(--vscode-descriptionForeground)';
          commentsContainer.appendChild(noComments);
        } else {
          // Display each comment
          comments.forEach((comment, index) => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';

            // Format the comment text
            const commentText = document.createElement('pre');
            commentText.textContent = comment;

            commentElement.appendChild(commentText);
            commentsContainer.appendChild(commentElement);
          });
        }

        childrenContainerElement.appendChild(commentsContainer);
      }

      // Function to show error
      function showError(message) {
        const errorElement = document.createElement('div');
        errorElement.className = 'error-message';
        errorElement.textContent = message;

        // Add to body
        document.body.appendChild(errorElement);

        // Remove after 5 seconds
        setTimeout(() => {
          errorElement.remove();
        }, 5000);
      }

      // Function to show no workspace message
      function showNoWorkspaceMessage() {
        // Clear containers
        fileDetailsElement.innerHTML = '';
        childrenContainerElement.innerHTML = '';

        // Update title
        fileNameElement.textContent = 'No Workspace Open';
        filePathElement.textContent = '';

        // Create message
        const messageElement = document.createElement('div');
        messageElement.style.textAlign = 'center';
        messageElement.style.padding = '20px';
        messageElement.style.marginTop = '50px';

        // Create message paragraph
        const p1 = document.createElement('p');
        p1.textContent = 'No workspace is currently open.';
        messageElement.appendChild(p1);

        const p2 = document.createElement('p');
        p2.textContent = 'Please open a folder or browse for a file to view details.';
        messageElement.appendChild(p2);

        // Create browse button
        const browseButton = document.createElement('button');
        browseButton.id = 'browseButton';
        browseButton.textContent = 'Browse...';
        browseButton.style.marginTop = '20px';
        browseButton.style.padding = '8px 16px';
        messageElement.appendChild(browseButton);

        childrenContainerElement.appendChild(messageElement);

        // Add click handler to browse button
        document.getElementById('browseButton').addEventListener('click', () => {
          vscode.postMessage({
            command: 'browseWorkspace'
          });
        });
      }

      // Handle messages from the extension
      window.addEventListener('message', event => {
        const message = event.data;

        switch (message.command) {
          case 'setCurrentFile':
            currentFileUri = message.fileUri;
            fileNameElement.textContent = message.fileName;
            break;

          case 'fileDetails':
            displayFileDetails(message.details);
            // Set current view mode from details
            if (message.details.viewMode) {
              currentViewMode = message.details.viewMode;
            }
            break;

          case 'children':
            // Check if this is a response to a folder expansion
            if (message.parentUri && message.parentUri !== currentFileUri) {
              // Find the folder children container
              const folderChildren = document.querySelector('.folder-children[data-parent="' + message.parentUri + '"]');

              if (folderChildren) {
                // Clear loading indicator
                folderChildren.innerHTML = '';

                // Display children in the folder container
                message.children.forEach(child => {
                  const childElement = document.createElement('div');
                  childElement.className = 'child-item';
                  childElement.dataset.uri = child.uri;

                  // Icon
                  const iconElement = document.createElement('div');
                  iconElement.className = 'child-icon';
                  iconElement.textContent = getFileTypeIcon(child.type);
                  childElement.appendChild(iconElement);

                  // Name
                  const nameElement = document.createElement('div');
                  nameElement.className = 'child-name';
                  nameElement.textContent = child.name;
                  childElement.appendChild(nameElement);

                  // Click handler
                  if (child.isDirectory) {
                    childElement.addEventListener('click', (e) => {
                      e.stopPropagation();

                      // Check if folder children already exist
                      const existingChildren = document.querySelector('.folder-children[data-parent="' + child.uri + '"]');

                      if (existingChildren) {
                        // Toggle expanded state
                        existingChildren.classList.toggle('expanded');
                      } else {
                        // Create folder children container
                        const nestedFolderChildren = document.createElement('div');
                        nestedFolderChildren.className = 'folder-children expanded';
                        nestedFolderChildren.dataset.parent = child.uri;

                        // Add loading indicator
                        const loadingElement = document.createElement('div');
                        loadingElement.textContent = 'Loading...';
                        nestedFolderChildren.appendChild(loadingElement);

                        // Insert after the current child
                        childElement.parentNode.insertBefore(nestedFolderChildren, childElement.nextSibling);

                        // Request children
                        vscode.postMessage({
                          command: 'getChildren',
                          fileUri: child.uri
                        });
                      }
                    });
                  } else {
                    childElement.addEventListener('click', (e) => {
                      e.stopPropagation();
                      vscode.postMessage({
                        command: 'openFile',
                        fileUri: child.uri
                      });
                    });
                  }

                  folderChildren.appendChild(childElement);
                });
              }
            } else {
              // Display children in the main container
              displayChildren(message.children, message.viewMode);
            }
            break;

          case 'clearChildren':
            childrenContainerElement.innerHTML = '';
            break;

          case 'fileComments':
            displayFileComments(message.comments, message.filePath);
            break;

          case 'error':
            showError(message.message);
            break;

          case 'noWorkspace':
            showNoWorkspaceMessage();
            break;

          case 'detailsSaved':
            // Could show a notification or update UI if needed
            break;
        }
      });

      // Initial request for file details if we have a URI
      if (currentFileUri) {
        vscode.postMessage({
          command: 'getFileDetails',
          fileUri: currentFileUri
        });
      }
    })();
  </script>
</body>

</html>